<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Rubik's Cube â€“ Quaternion Fixed (Full)</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#111; font-family:sans-serif; }
    /* UI */
    #rubiks-menu {
      position:absolute; top:20px; left:20px; z-index:100;
      display:flex; flex-wrap:wrap; gap:12px; max-width:380px;
    }
    /* Knob UI and half buttons */
    .control-knob { width:50px; height:50px; background:white; border-radius:50%; position:relative; overflow:hidden; }
    .half-btn { position:absolute; width:50%; height:100%; border:none; cursor:pointer; }
    .half-btn.left { left:0; background:#ff6b6b; }
    .half-btn.right { right:0; background:#6a95ff; }
    .knob-label {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-weight:900; pointer-events:none;
    }
    /* Scamble button UI */
    .scramble-container { position:absolute; bottom:30px; left:50%; transform:translateX(-50%); z-index:100; }
    .scramble-btn { padding:12px 24px; font-size:1.2rem; font-weight:bold; border-radius:8px; border:none; background:#f39c12; color:white; }
  </style>
</head>

<body>

<div id="rubiks-menu">
  <div class="control-knob"><button class="half-btn left" onclick="rotateSlice('U_N')"></button><button class="half-btn right" onclick="rotateSlice('U')"></button><span class="knob-label">U</span></div>
  <div class="control-knob"><button class="half-btn left" onclick="rotateSlice('D_N')"></button><button class="half-btn right" onclick="rotateSlice('D')"></button><span class="knob-label">D</span></div>
  <div class="control-knob"><button class="half-btn left" onclick="rotateSlice('L_N')"></button><button class="half-btn right" onclick="rotateSlice('L')"></button><span class="knob-label">L</span></div>
  <div class="control-knob"><button class="half-btn left" onclick="rotateSlice('R_N')"></button><button class="half-btn right" onclick="rotateSlice('R')"></button><span class="knob-label">R</span></div>
  <div class="control-knob"><button class="half-btn left" onclick="rotateSlice('F_N')"></button><button class="half-btn right" onclick="rotateSlice('F')"></button><span class="knob-label">F</span></div>
  <div class="control-knob"><button class="half-btn left" onclick="rotateSlice('B_N')"></button><button class="half-btn right" onclick="rotateSlice('B')"></button><span class="knob-label">B</span></div>
  <div class="control-knob"><button class="half-btn left" onclick="rotateSlice('Mx_N')"></button><button class="half-btn right" onclick="rotateSlice('Mx')"></button><span class="knob-label">Mx</span></div>
  <div class="control-knob"><button class="half-btn left" onclick="rotateSlice('My_N')"></button><button class="half-btn right" onclick="rotateSlice('My')"></button><span class="knob-label">My</span></div>
  <div class="control-knob"><button class="half-btn left" onclick="rotateSlice('Mz_N')"></button><button class="half-btn right" onclick="rotateSlice('Mz')"></button><span class="knob-label">Mz</span></div>
</div>

<div class="scramble-container">
  <button id="scrambleBtn" class="scramble-btn" onclick="scrambleCube()">SCRAMBLE</button>
</div>

<a-scene renderer="physicallyCorrectLights: true; antialias: true" shadow="type: pcfsoft">
   <a-assets>
      <a-asset-item id="cube-model" src="https://kostasgian21.github.io/computer_graphics/rubiks_cube_standard_solid_v3.glb"></a-asset-item>
      <img id="skyTexture" src="https://raw.githubusercontent.com/GiorgosKalos/Graphic/main/beautiful-clouds-scenery.jpg">
    </a-assets>
    
    <a-sky src="#skyTexture"></a-sky>
  <!-- Lighting-Shadows -->
  <a-entity light="ambient; intensity:0.7"></a-entity>
  <a-entity light="directional; intensity:5; castShadow: true; color:#EDEAE0;" position="-3 6 0"></a-entity>
  <a-entity light="point; intensity: 1.50; distance: 20;" position="0 4 2"></a-entity>
  <a-entity light="point; intensity: 1.50; distance: 20;" position="4 0 2"></a-entity>
  <a-entity light="point; intensity: 1; distance: 20;" position="0 3 -8"></a-entity>
 
  <a-entity id="cube-cluster"></a-entity>
  <!-- Plane -->
  <a-plane position="0 0 -4" rotation="-90 0 0" width="15" height="15" color="#6a95ff" shadow="receive: true"></a-plane>
  <!-- Camera -->
  <a-entity position="0 2 5">
    <a-camera look-controls wasd-controls></a-camera>
  </a-entity>
</a-scene>

<script>
const cubeSize = 0.8;
const cubelets = [];
const cluster = document.getElementById('cube-cluster');

// Center Facet Calc
const sliceDefs = {
  U:  { center:[0,3,-3], axis:'y', angle:-90, match:(x,y,z)=>y===3 },
  D:  { center:[0,1,-3], axis:'y', angle:-90, match:(x,y,z)=>y===1 },
  L:  { center:[-1,2,-3], axis:'x', angle:-90, match:(x,y,z)=>x===-1 },
  R:  { center:[1,2,-3], axis:'x', angle: 90, match:(x,y,z)=>x===1 },
  F:  { center:[0,2,-2], axis:'z', angle:-90, match:(x,y,z)=>z===-2 },
  B:  { center:[0,2,-4], axis:'z', angle:-90, match:(x,y,z)=>z===-4 },
  Mx: { center:[0,2,-3], axis:'x', angle: 90, match:(x,y,z)=>x===0 },
  My: { center:[0,2,-3], axis:'y', angle:-90, match:(x,y,z)=>y===2 },
  Mz: { center:[0,2,-3], axis:'z', angle:-90, match:(x,y,z)=>z===-3 },
};

// Creating the cube
for (let y of [1,2,3]) {
  for (let x of [-1,0,1]) {
    for (let z of [-2,-3,-4]) {
      const el = document.createElement('a-entity');
      el.setAttribute('gltf-model','#cube-model');
      el.setAttribute('scale',`${cubeSize} ${cubeSize} ${cubeSize}`);
      // Initial Position
      el.object3D.position.set(x,y,z);
      el.object3D.quaternion.identity();
      el.setAttribute('shadow','cast : true');

      // Store logical coordinates
      el.dataset.x=x; el.dataset.y=y; el.dataset.z=z;

      cluster.appendChild(el);
      cubelets.push(el);
    }
  }
}


// Animating Position and Rotation 
function animateMove(el, targetPos, targetQuat, duration) {
  const startPos = el.object3D.position.clone();
  const startQuat = el.object3D.quaternion.clone();
  const startTime = performance.now();

  function loop(now) {
    const elapsed = now - startTime;
    let t = elapsed / duration;
    if(t > 1) t = 1;

    // EaseInOutQuad
    const ease = t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t;

    // Interpolate
    el.object3D.position.lerpVectors(startPos, targetPos, ease);
    el.object3D.quaternion.slerpQuaternions(startQuat, targetQuat, ease);

    if (t < 1) {
      requestAnimationFrame(loop);
    } else {
      // Ensure exact final state to prevent float drift
      el.object3D.position.copy(targetPos);
      el.object3D.quaternion.copy(targetQuat);
    }
  }
  requestAnimationFrame(loop);
}

// Core rotation
function rotateSlice(move) {
  const neg = move.endsWith('_N');
  const key = neg ? move.replace('_N','') : move;
  const def = sliceDefs[key];
  if (!def) return;

  const axis = new THREE.Vector3();
  axis[def.axis] = 1;

  const rad = THREE.MathUtils.degToRad((neg?-1:1)*def.angle);
  const pivot = new THREE.Vector3(...def.center);

  cubelets.filter(el => 
    def.match(+el.dataset.x,+el.dataset.y,+el.dataset.z)
  ).forEach(el => {
    
    // Calculate target position
    const currentPos = el.object3D.position.clone();
    // Rotate point around pivot
    currentPos.sub(pivot).applyAxisAngle(axis, rad).add(pivot);
    
    // Round to nearest integer to stay on grid
    const targetPos = new THREE.Vector3(
      Math.round(currentPos.x),
      Math.round(currentPos.y),
      Math.round(currentPos.z)
    );

    // Calculate Target Rotation
    const q = new THREE.Quaternion().setFromAxisAngle(axis, rad);
    const targetQuat = el.object3D.quaternion.clone().premultiply(q);

    // Update Logical Coordinates Immediately
    el.dataset.x = targetPos.x;
    el.dataset.y = targetPos.y;
    el.dataset.z = targetPos.z;

    // Trigger Animation
    animateMove(el, targetPos, targetQuat, 500);
  });
}

// Scramble function
async function scrambleCube() {
  const moves = Object.keys(sliceDefs).flatMap(m=>[m,m+'_N']);
  for(let i=0;i<15;i++){
    rotateSlice(moves[Math.floor(Math.random()*moves.length)]);
    await new Promise(r=>setTimeout(r,550));
  }
}

window.rotateSlice = rotateSlice;
window.scrambleCube = scrambleCube;
</script>

</body>

</html>

